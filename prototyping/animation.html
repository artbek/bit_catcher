<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<script type="application/javascript">

		var score = -1;
		var display = [
			0b00011111,
			0b00000000,
			0b00000000,
			0b00000000,
			0b00000000,
			0b00000000,
			0b00000000
		];

		function display_get(c, r) {
			return display[r] & (1 << (4 - c));
		}

		function saucer_get(c) {
			return saucer & (1 << (4 - c));
		}

		function display_set(c, r) {
			display[r] |= (1 << (4 - c));
		}

		function display_clear(c, r) {
			display[r] &= ~(1 << (4 - c));
		}

		function display_row_clear(r) {
			display[r] = 0b00000000;
		}

		var px_size = 6;
		var px_gap = 16;

		var canvas = null;
		var ctx = null;
					var game_over = false;

		function init() {
			//console.log('initing...');
			canvas = document.getElementById('canvas');
			if (canvas && canvas.getContext) {
				ctx = canvas.getContext('2d');
			}
		}

var score__digits_count = 0;
var score__actual_digits = [];

		function flush() {
			if (! canvas) {
				init();
				return;
			}


			if (! game_over && display[6]) {
				if (display[6] & saucer) {
					score++;
					console.log(score);
				} else {
					game_over = true;
					score = 120;
					var temp_score = score;
					while (Math.floor(temp_score / 10)) {
						score__actual_digits[score__digits_count] = temp_score % 10;
						score__digits_count++;
						temp_score = Math.floor(temp_score / 10);
					}

					score__actual_digits[score__digits_count] = temp_score;

					show_score_scroll_max = 5 * score__digits_count;
				}
			}


			//console.log('flushing...');
			for (r = 0; r < 7; r++) {
				for (c = 0; c < 5; c++) {
					if (display_get(c, r)) {
						ctx.fillStyle = 'rgb(255, 150, 150)';
						ctx.fillRect(c * px_gap, r * px_gap, px_size, px_size);
					} else {
						ctx.fillStyle = 'rgb(100, 20, 20)';
						ctx.fillRect(c * px_gap, r * px_gap, px_size, px_size);
					}
				}
			}

			flush_saucer();

		}

		function flush_saucer() {
			if (game_over) return;

			for (c = 0; c < 5; c++) {
				if (saucer_get(c)) {
					ctx.fillStyle = 'rgb(255, 150, 150)';
					ctx.fillRect(c * px_gap, 6 * px_gap, px_size, px_size);
				} else {
					ctx.fillStyle = 'rgb(100, 20, 20)';
					ctx.fillRect(c * px_gap, 6 * px_gap, px_size, px_size);
				}
			}
		}

var positions = [1, 1, 0, 2, 4, 3, 0, 0, 4, 0, 2, 1, 0, 4, 1, 2, 4, 0, 1, 2, 4, 3, 4, 1, 4, 1, 4, 2, 2, 1, 4, 0, 3, 3, 1, 1, 1, 3, 0, 1, 2, 2, 1, 1, 2, 4, 4, 2, 3, 3, 0, 1, 4, 3, 1, 3, 3, 0, 0, 2, 4, 4, 0, 4, 0, 0, 4, 1, 4, 1, 0, 0, 0, 1, 4, 0, 3, 0, 3, 3, 3, 3, 4, 2, 3, 4, 3, 0, 0, 2, 2, 1, 2, 4, 4, 0, 0, 3, 0, 3];

var rows = [
	0b00010000,
	0b00001000,
	0b00000100,
	0b00000010,
	0b00000001
];

		var position_index = 0;

		function paint_row() {
			//console.log("paint_row()")

			display[0] = rows[positions[position_index]];
			position_index++;
			if (position_index >= positions.length) {
				position_index = 0;
			}
		}

		function paint_blank_row() {
			display_row_clear(0);
		}

		var gap_countdown = 5;

		var show_score_scroll = 0;
		var show_score_scroll_direction = 1;

		function show_score() {
			// starting digit
			var digit_index = Math.floor(show_score_scroll / 5);
			var digit_column_index = (show_score_scroll % 5);

			for (i = 0; i < 5; i++) {
				for (r = 0; r < 7; r++) {
					var actual_digit = score__actual_digits[score__digits_count - digit_index];
					if (digits[actual_digit][r] & (1 << (4 - digit_column_index))) {
						display_set(i, r);
					} else {
						display_clear(i, r);
					}
				}

				digit_column_index++;
				if (digit_column_index > 4) {
					digit_column_index = 0;
					digit_index++;

					// insert spacer column
					i++;
					for (r = 0; r < 7; r++) {
						display_clear(i, r);
					}
				}
			}

			show_score_scroll += show_score_scroll_direction;

			if (show_score_scroll > show_score_scroll_max) {
				show_score_scroll = show_score_scroll_max;
				show_score_scroll_direction = -1;
			}

			if (show_score_scroll < 0) {
				show_score_scroll = 0;
				show_score_scroll_direction = 1;
			}
		}

		var digits = [
			[
				0b00001110,
				0b00010001,
				0b00010001,
				0b00010001,
				0b00010001,
				0b00010001,
				0b00001110,
			],
			[
				0b00000100,
				0b00001100,
				0b00010100,
				0b00000100,
				0b00000100,
				0b00000100,
				0b00011111,
			],
			[
				0b00001110,
				0b00010001,
				0b00010010,
				0b00000100,
				0b00000100,
				0b00001000,
				0b00011111,
			],
			[
				0b00001110,
				0b00010001,
				0b00010010,
				0b00000100,
				0b00000100,
				0b00001000,
				0b00011111,
			],
			[
				0b00001110,
				0b00010001,
				0b00010010,
				0b00000100,
				0b00000100,
				0b00001000,
				0b00011111,
			],
			[
				0b00001110,
				0b00010001,
				0b00010010,
				0b00000100,
				0b00000100,
				0b00001000,
				0b00011111,
			],
			[
				0b00001110,
				0b00010001,
				0b00010010,
				0b00000100,
				0b00000100,
				0b00001000,
				0b00011111,
			],
			[
				0b00001110,
				0b00010001,
				0b00010010,
				0b00000100,
				0b00000100,
				0b00001000,
				0b00011111,
			],
			[
				0b00001110,
				0b00010001,
				0b00010010,
				0b00000100,
				0b00000100,
				0b00001000,
				0b00011111,
			],
			[
				0b00001110,
				0b00010001,
				0b00010010,
				0b00000100,
				0b00000100,
				0b00001000,
				0b00011111,
			],
		];

		function update_display() {

			if (game_over) {

				show_score();

			} else {

				//console.log("updating...");
				for (r = 6; r >= 0; r--) {
					if (r > 0) {
						display[r] = display[r-1];
					} else {
						if (! gap_countdown) {
							paint_row();
							gap_countdown = 3 + Math.floor(Math.random() * 3);
						} else {
							paint_blank_row();
						}
					}
				}

				gap_countdown--;
			}
		}

		setInterval(function() {
			update_display();
			flush();
		}, 200);

		var saucer = 0b00011000;

		document.onkeypress = function (e) {
	    e = e || window.event;
			if (e.keyCode == 106) { //left
				//console.log("LEFT");
				if (saucer < 0b00011000) {
					saucer = saucer << 1;
				}
			} else if (e.keyCode == 108) {
				//console.log("RIGHT");
				if (saucer > 0b00000011) {
					saucer = saucer >> 1;
				}
			}

			//console.log(saucer.toString(2));

			flush_saucer();
		}

		</script>
	</head>
	<body style="background: #030303">
		<canvas id="canvas" width="150" height="150"></canvas>
	</body>
</html>
